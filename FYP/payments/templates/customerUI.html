<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Work+Sans%3Awght%40400%3B500%3B700%3B900" />
    <title>Customer Dashboard</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
      .disabled-style {
        background-color: #f3f4f6;
        cursor: not-allowed;
        pointer-events: none;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-slate-50 group/design-root overflow-x-hidden"
         style='--select-button-svg: url("data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724px%27 height=%2724px%27 fill=%27rgb(78,115,151)%27 viewBox=%270 0 256 256%27%3e%3cpath d=%27M181.66,170.34a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32,0l-48-48a8,8,0,0,1,11.32-11.32L128,212.69l42.34-42.35A8,8,0,0,1,181.66,170.34Zm-96-84.68L128,43.31l42.34,42.35a8,8,0,0,0,11.32-11.32l-48-48a8,8,0,0,0-11.32,0l-48,48A8,8,0,0,0,85.66,85.66Z%27%3e%3c/path%3e%3c/svg%3e"); font-family: "Work Sans", "Noto Sans", sans-serif;'>
      <!-- Main container -->
      <div class="layout-container flex h-full grow flex-col">
        <!-- Header -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#e7edf3] px-10 py-3">
          <div class="flex items-center gap-4 text-[#0e141b]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_6_535)">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M47.2426 24L24 47.2426L0.757355 24L24 0.757355L47.2426 24ZM12.2426 21H35.7574L24 9.24264L12.2426 21Z" fill="currentColor"></path>
                </g>
                <defs>
                  <clipPath id="clip0_6_535">
                    <rect width="48" height="48" fill="white"></rect>
                  </clipPath>
                </defs>
              </svg>
            </div>
            <h2 class="text-[#0e141b] text-lg font-bold leading-tight tracking-[-0.015em]">SafePay</h2>
          </div>
          <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 bg-[#e7edf3] text-[#0e141b] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
            <div class="text-[#0e141b]" data-icon="Gear" data-size="20px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Zm88-29.84q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.21,107.21,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.71,107.71,0,0,0-26.25-10.87,8,8,0,0,0-7.06,1.49L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,73.89,34.51a8,8,0,0,0-3.93,6L67.32,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.25,8,8,0,0,0,1.49,7.06L40,125.84Q40,128,40,130.16L25.11,148.8a8,8,0,0,0-1.48,7.06,107.21,107.21,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.25,10.87,8,8,0,0,0,7.06-1.49L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.25,8,8,0,0,0-1.49-7.06Z"></path>
              </svg>
            </div>
          </button>
        </header>

        <!-- Two-column layout -->
        <div class="gap-1 px-6 flex flex-1 justify-center py-5">
          <!-- Left Column: Navigation -->
          <div class="layout-content-container flex flex-col w-80 bg-slate-50 p-4">
            <div class="flex flex-col gap-4">
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3 px-3 py-2 rounded-xl bg-[#e7edf3]">
                  <div class="text-[#0e141b]" data-icon="ArrowUp" data-size="24px" data-weight="fill">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                      <path d="M207.39,115.06A8,8,0,0,1,200,120H136v96a8,8,0,0,1-16,0V120H56a8,8,0,0,1-5.66-13.66l72-72a8,8,0,0,1,11.32,0l72,72A8,8,0,0,1,207.39,115.06Z"></path>
                    </svg>
                  </div>
                  <p class="text-[#0e141b] text-sm font-medium leading-normal">Send</p>
                </div>
                <div class="flex items-center gap-3 px-3 py-2"></div>
                <div class="flex items-center gap-3 px-3 py-2">
                  <form action="{% url 'logout' %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="localStorage.clear();" class="flex items-center gap-3">
                      <div class="text-[#0e141b]" data-icon="SignOut" data-size="24px" data-weight="regular">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                          <path d="M112,216a8,8,0,0,1-8,8H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h56a8,8,0,0,1,0,16H48V208h56A8,8,0,0,1,112,216Zm109.66-93.66-40-40a8,8,0,0,0-11.32,11.32L196.69,120H104a8,8,0,0,0,0,16h92.69l-26.35,26.34a8,8,0,0,0,11.32,11.32l40-40A8,8,0,0,0,221.66,122.34Z"></path>
                        </svg>
                      </div>
                      <p class="text-[#0e141b] text-sm font-medium leading-normal " >Log Out</p>
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="flex px-4 py-3 justify-center">
              <a href="{% url 'view_purchase' %}" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 flex-1 bg-[#e7edf3] text-[#0e141b] text-sm font-bold leading-normal tracking-[0.015em]">
                <span class="truncate">View Purchase</span>
              </a>
            </div>
            <div class="flex px-4 py-3 justify-center">
              <a href="{% url 'contact_support' %}?dashboard=customer" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 flex-1 bg-[#e7edf3] text-[#0e141b] text-sm font-bold leading-normal tracking-[0.015em]">
                <span class="truncate">Contact Support</span>
              </a>
            </div>
          </div>
          
          <!-- Right Column: "Send Money" Form + Customer Details -->
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <!-- Heading -->
            <div class="flex flex-wrap justify-between gap-3 p-4">
              <p class="text-[#0e141b] text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">
                Send Money
              </p>
            </div>
            
            <!-- Payment Form with validation -->
            <form method="post" action="{% url 'process_money_transfer' %}" onsubmit="return validateForm(event);">
              {% csrf_token %}
              <!-- "To" label -->
              <div class="flex items-center gap-4 bg-slate-50 px-4 min-h-14 justify-between">
                <p class="text-[#0e141b] text-base font-normal leading-normal flex-1 truncate">To</p>
              </div>
              
              <!-- Merchant Email (Required) -->
              <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <label class="flex flex-col min-w-40 flex-1">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">
                    Merchant Email <span class="text-red-500">*</span>
                  </span>
                  <input name="merchant_email" type="email" placeholder="Enter Merchant Email" oninput="storeInLocalStorage()" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base text-[#0e141b] placeholder:text-[#4e7397] focus:outline-0 focus:ring-0 focus:border-[#d0dbe7]" />
                </label>
              </div>
              
              <!-- Amount & Currency (Both Required) -->
              <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <label class="flex flex-col min-w-40 flex-1">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">
                    Amount <span class="text-red-500">*</span>
                  </span>
                  <input name="amount" id="amountInput" type="number" placeholder="$0.00" step="0.01" min="0" oninput="storeInLocalStorage()" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base text-[#0e141b] placeholder:text-[#4e7397] focus:outline-0 focus:ring-0 focus:border-[#d0dbe7]" />
                </label>
                <label class="flex flex-col min-w-40 flex-1">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">
                    Currency <span class="text-red-500">*</span>
                  </span>
                  <select name="currency" id="currencySelect" oninput="storeInLocalStorage()" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base text-[#0e141b] placeholder:text-[#4e7397] focus:outline-0 focus:ring-0 focus:border-[#d0dbe7]">
                    <option value="">Select Currency</option>
                    <option value="SGD">SGD</option>
                    <option value="USD">USD</option>
                    <option value="MYR">MYR</option>
                  </select>
                </label>
              </div>
              
              <!-- Total Cost, Loading Indicator, and Error Message -->
              <div id="totalCost" class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3 hidden">
                <p class="text-[#0e141b] text-base font-medium leading-normal">
                  Estimated Converted Cost: <span id="calculatedCost">$0.00</span>
                </p>
              </div>
              <div id="loadingIndicator" class="text-sm text-[#4e7397] px-4 py-3 hidden">Loading exchange rates...</div>
              <div id="errorMessage" class="text-sm text-red-500 px-4 py-3 hidden">Failed to load exchange rates. Please try again later.</div>
              
              <!-- Exchange Rate Script -->
              <script>
                const amountInput = document.getElementById('amountInput');
                const currencySelect = document.getElementById('currencySelect');
                const totalCostDisplay = document.getElementById('totalCost');
                const calculatedCost = document.getElementById('calculatedCost');
                const loadingIndicator = document.getElementById('loadingIndicator');
                const errorMessage = document.getElementById('errorMessage');
                let exchangeRates = { SGD: 1 };
                async function fetchExchangeRates() {
                  const apiKey = '328d1dd82d51617bec9c66ee';
                  const url = `https://v6.exchangerate-api.com/v6/${apiKey}/latest/SGD`;
                  try {
                    loadingIndicator.classList.remove('hidden');
                    errorMessage.classList.add('hidden');
                    const response = await fetch(url);
                    if (!response.ok) {
                      throw new Error(`HTTP Error: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.result === 'success' && data.conversion_rates) {
                      exchangeRates = { SGD: 1, USD: data.conversion_rates.USD, MYR: data.conversion_rates.MYR };
                    } else {
                      throw new Error('Invalid API data');
                    }
                  } catch (error) {
                    console.error('Error fetching exchange rates:', error);
                    errorMessage.classList.remove('hidden');
                  } finally {
                    loadingIndicator.classList.add('hidden');
                  }
                }
                function calculateTotalCost() {
                  const amount = parseFloat(amountInput.value);
                  let currency = currencySelect.value;
                  if (!currency) { currency = 'SGD'; }
                  if (!isNaN(amount)) {
                    const total = amount * exchangeRates[currency];
                    calculatedCost.textContent = `${currency} ${total.toFixed(2)}`;
                    totalCostDisplay.classList.remove('hidden');
                  } else {
                    totalCostDisplay.classList.add('hidden');
                  }
                }
                fetchExchangeRates();
                setInterval(fetchExchangeRates, 12 * 60 * 60 * 1000);
                amountInput.addEventListener('input', calculateTotalCost);
                currencySelect.addEventListener('change', calculateTotalCost);
              </script>

              <!-- Saved Cards Section -->
              <div id="savedCardSection" class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <label class="text-[#0e141b] text-sm font-semibold mb-1">Use Saved Card <span class="text-red-500">*</span></label>
                <p class="text-sm text-[#4e7397] italic mb-1">
                  You can either use a saved card OR enter a new card below.
                </p>
                <select id="saved_cards" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base">
                  <option value="">-- Select Saved Card --</option>
                  <!-- options will be added via JS -->
                </select>
                <input type="hidden" name="saved_card_id" id="saved_card_id" value="">
                <button type="button" onclick="deleteSelectedCard()" class="text-red-500 underline text-sm whitespace-nowrap">
                  Delete
                </button>
              </div>

              <!-- OR Divider -->
              <div class="flex items-center my-3">
                <hr class="flex-grow border-t border-gray-300">
                <span class="mx-2 text-gray-400 text-sm italic">or</span>
                <hr class="flex-grow border-t border-gray-300">
              </div>
                            
              <!-- Payment Method, Card Number, CVV & Wallet Section -->
              <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <!-- Payment Method Select (Required) -->
                <label class="flex flex-col min-w-40 flex-1">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">
                    Payment Method <span class="text-red-500">*</span>
                  </span>
                  <select name="payment_method" id="paymentMethod" oninput="storeInLocalStorage()" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base text-[#0e141b] placeholder:text-[#4e7397] focus:outline-0 focus:ring-0 focus:border-[#d0dbe7]">
                    <option value="">Select Payment Method</option>
                    <option value="VISA">VISA</option>
                    <option value="CREDIT CARD">CREDIT CARD</option>
                    <option value="SAFEPAY WALLET">SafePay Wallet</option>
                  </select>
                </label>

                
                <!-- Card Number Field (Shown for VISA/CREDIT CARD) -->
                <label id="cardNumberLabel" class="flex flex-col min-w-40 flex-1 hidden">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">
                    Bank Card Number <span class="text-red-500">*</span>
                  </span>
                  <input name="card_number" type="text" placeholder="16 digits" oninput="storeInLocalStorage()" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base text-[#0e141b] placeholder:text-[#4e7397] focus:outline-0 focus:ring-0 focus:border-[#d0dbe7]" />
                </label>

                <!-- Expiry Date Field (MM/YY format) -->
                <label id="expiryDateLabel" class="flex flex-col min-w-40 flex-1 hidden">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">
                    Expiry Date <span class="text-red-500">*</span>
                  </span>
                  <input name="expiry_date" type="text" placeholder="MM/YY" pattern="\d{2}/\d{2}" oninput="storeInLocalStorage()" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base text-[#0e141b] placeholder:text-[#4e7397] focus:outline-0 focus:ring-0 focus:border-[#d0dbe7]" />
                </label>

                <!-- CVV Field (Shown for VISA/CREDIT CARD) -->
                <label id="cvvLabel" class="flex flex-col min-w-40 flex-1 hidden">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">
                    CVV <span class="text-red-500">*</span>
                  </span>
                  <input name="cvv" type="text" placeholder="3 digits" oninput="storeInLocalStorage()" class="form-input w-full rounded-xl border border-[#d0dbe7] bg-slate-50 h-14 p-[15px] text-base text-[#0e141b] placeholder:text-[#4e7397] focus:outline-0 focus:ring-0 focus:border-[#d0dbe7]" />
                </label>
                {% if messages %}
                    <div class="messages">
                        {% for message in messages %}
                            {% if message.tags == 'error' %}
                                <div class="alert alert-danger text-red-600 mt-2">{{ message }}</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                <!-- Wallet Section (Shown for SafePay Wallet) -->
                <div id="walletSection" class="flex flex-col min-w-40 flex-1 hidden">
                  <span class="mb-1 text-[#0e141b] text-sm font-semibold">Wallet Balance</span>
                  <p class="text-[#0e141b] text-sm">$ {{ wallet_balance|floatformat:2 }}</p>
                  <a href="{% url 'top_up_wallet' %}" class="text-blue-500 underline text-sm">Top Up Wallet</a>
                </div>
                <script>
                  const paymentMethod = document.getElementById('paymentMethod');
                  const cardNumberLabel = document.getElementById('cardNumberLabel');
                  const cvvLabel = document.getElementById('cvvLabel');
                  const walletSection = document.getElementById('walletSection');
                  const expiryDateLabel = document.getElementById('expiryDateLabel');
                  function togglePaymentFields() {
                    if (paymentMethod.value === "SAFEPAY WALLET") {
                      cardNumberLabel.classList.add('hidden');
                      cvvLabel.classList.add('hidden');
                      expiryDateLabel.classList.add('hidden');
                      walletSection.classList.remove('hidden');
                    } else if (paymentMethod.value !== "") {
                      cardNumberLabel.classList.remove('hidden');
                      cvvLabel.classList.remove('hidden');
                      expiryDateLabel.classList.remove('hidden');
                      walletSection.classList.add('hidden');
                    } else {
                      cardNumberLabel.classList.add('hidden');
                      cvvLabel.classList.add('hidden');
                      expiryDateLabel.classList.add('hidden');
                      walletSection.classList.add('hidden');
                    }
                  }
                  togglePaymentFields();
                  paymentMethod.addEventListener('change', togglePaymentFields);
                </script>
              </div>

              <div class="flex items-center gap-4 bg-slate-50 px-4 min-h-[72px] py-2 justify-between">
                <div class="flex flex-col justify-center">
                  <div class="flex items-center gap-2">
                    <p class="text-[#0e141b] text-base font-medium leading-normal line-clamp-1">
                      Save Your Card
                    </p>
                    <!-- Info icon with tooltip -->
                    <span class="group relative inline-block align-middle">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 cursor-pointer inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM9 9h2v5H9V9z" clip-rule="evenodd" />
                      </svg>
                      <span class="absolute z-10 hidden group-hover:block w-64 bg-white border border-gray-300 text-sm text-gray-700 p-2 rounded shadow-lg -left-1/2 mt-2 whitespace-normal">
                        Card numbers are securely encrypted and stored. Only the last 4 digits are visible.
                      </span>
                    </span>
                  </div>
                  <p class="text-[#4e7397] text-sm font-normal leading-normal line-clamp-2 mt-1">
                    Enable this to save your bank card for future transactions
                  </p>
                </div>
              
              
                <div class="shrink-0">
                  <label class="relative flex h-[31px] w-[51px] cursor-pointer items-center rounded-full border-none bg-[#e7edf3] p-0.5">
                    
                    <!-- checkbox -->
                    <input 
                      type="checkbox" 
                      name="save_payment_method" 
                      class="absolute left-0 top-0 w-full h-full opacity-0 z-10 cursor-pointer"
                      {% if has_saved_cards %}checked{% endif %}
                    />
              
                    <!-- （toggle） -->
                    <div 
                      class="h-full w-[27px] rounded-full bg-white transform transition-transform duration-200 ease-in-out"
                      id="toggleSwitchBall"
                    ></div>
                  </label>
                </div>
              </div>

              <script>
                document.addEventListener("DOMContentLoaded", () => {
                  const checkbox = document.querySelector('input[name="save_payment_method"]');
                  const ball = document.getElementById('toggleSwitchBall');
              
                  function updateSwitch() {
                    if (checkbox.checked) {
                      ball.style.transform = 'translateX(20px)';
                    } else {
                      ball.style.transform = 'translateX(0px)';
                    }
                  }
              
                  checkbox.addEventListener('change', updateSwitch);
                  updateSwitch(); 
                });
              </script>
              
              <!-- Submit Button -->
              <div class="flex px-4 py-3 justify-center">
                <button type="submit" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 flex-1 bg-[#1980e6] text-slate-50 text-sm font-bold leading-normal tracking-[0.015em]">
                  <span class="truncate">Send</span>
                </button>
              </div>
            </form>
          
            
            <!-- Customer Details -->
            <div class="flex-1 bg-white p-6 shadow-sm">
              <h2 class="text-xl font-bold text-slate-900 mb-4">Customer Details</h2>
              <p class="text-slate-700"><strong>Customer ID:</strong> {{user_id}}</p>
              <p class="text-slate-700"><strong>Customer Email:</strong> {{email}}</p>
              <p class="text-slate-700"><strong>Customer First Name:</strong> {{first_name}}</p>
              <p class="text-slate-700"><strong>Customer Last Name:</strong> {{last_name}}</p>
              <p class="text-slate-700"><strong>Customer Phone Number:</strong> {{phone_number}}</p>
              <p class="text-slate-700"><strong>Customer Address:</strong> {{address}}</p>
              <p class="text-slate-700"><strong>Customer City:</strong> {{city}}</p>
              <p class="text-slate-700"><strong>Customer State:</strong> {{state}}</p>
              <p class="text-slate-700"><strong>Customer Country:</strong> {{country}}</p>
              <p class="text-slate-700"><strong>Customer Zipcode:</strong> {{zip_code}}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- VALIDATION SCRIPT -->
      <script>
        
        function validateForm(event) {
          const form = event.target;
          const merchantEmail = form.querySelector('input[name="merchant_email"]');
          const amountInput = form.querySelector('input[name="amount"]');
          const currency = form.querySelector('select[name="currency"]');
          const paymentMethod = form.querySelector('select[name="payment_method"]');
          const cardNumberInput = form.querySelector('input[name="card_number"]');
          const cvvInput = form.querySelector('input[name="cvv"]');
          const expiryDateInput = form.querySelector('input[name="expiry_date"]');
          const savedCardId = document.getElementById('saved_cards').value;
        
          // If using saved card, only validate CVV
          if (savedCardId) {
            if (cvvInput && !/^\d{3}$/.test(cvvInput.value)) {
              alert("Please enter the 3-digit CVV for your saved card.");
              event.preventDefault();
              return false;
            }
            return true; //STOP here, skip the rest
          }
        
          // Required fields
          if (
            !merchantEmail.value.trim() ||
            !amountInput.value.trim() ||
            !currency.value.trim() ||
            !paymentMethod.value.trim()
          ) {
            alert("Please fill in required blanks");
            event.preventDefault();
            return false;
          }
        
          // Wallet balance check
          if (paymentMethod.value === "SAFEPAY WALLET") {
            const walletBalance = parseFloat("{{ wallet_balance|floatformat:2 }}");
            const transactionAmount = parseFloat(amountInput.value);
            if (transactionAmount > walletBalance) {
              if (!confirm("Insufficient wallet balance. Please top up wallet")) {
                event.preventDefault();
                return false;
              }
            }
            return true;
          }
        
          // Manually entered card: full validation
          if (!/^\d{16}$/.test(cardNumberInput.value)) {
            alert("Bank card number must be 16 digits.");
            event.preventDefault();
            return false;
          }
        
          if (!/^\d{3}$/.test(cvvInput.value)) {
            alert("CVV must be exactly 3 digits.");
            event.preventDefault();
            return false;
          }
        
          if (!/^\d{2}\/\d{2}$/.test(expiryDateInput.value)) {
            alert("Expiry date must be in MM/YY format.");
            event.preventDefault();
            return false;
          }
        
          const [expMonth, expYear] = expiryDateInput.value.split('/');
          const expiryDate = new Date(2000 + parseInt(expYear), parseInt(expMonth), 0);
          const now = new Date();
          if (expiryDate < now) {
            alert("Card is expired.");
            event.preventDefault();
            return false;
          }
        
          return true;
        }
        
        
        
        function storeInLocalStorage() {
          const merchantEmail = document.querySelector('input[name="merchant_email"]').value;
          const amount = document.querySelector('input[name="amount"]').value;
          const currency = document.querySelector('select[name="currency"]').value;
          const paymentMethod = document.querySelector('select[name="payment_method"]').value;
          const cardNumber = document.querySelector('input[name="card_number"]').value;
          const cvv = document.querySelector('input[name="cvv"]').value;
          localStorage.setItem('merchant_email', merchantEmail);
          localStorage.setItem('amount', amount);
          localStorage.setItem('currency', currency);
          localStorage.setItem('payment_method', paymentMethod);
          localStorage.setItem('card_number', cardNumber);
          localStorage.setItem('cvv', cvv);
        }


        function loadSavedPaymentMethods() {
          fetch("{% url 'get_saved_payment_methods' %}")
              .then(response => response.json())
              .then(data => {
                  const select = document.getElementById('saved_cards');
                  select.innerHTML = '<option value="">-- Select saved card --</option>';
                  
                  data.methods.forEach(method => {
                      const option = document.createElement('option');
                      option.value = method.id;
                      option.textContent = method.display;
                      select.appendChild(option);
                  });
                  
                  if (data.methods.length > 0) {
                      document.getElementById('saved_cards').classList.remove('hidden');
                  }
              })
              .catch(error => {
                  console.error('Error loading saved payment methods:', error);
              });
        }
      
         function handleSavedCardSelection() {
          const savedCardSelect = document.getElementById('saved_cards');
          const selectedCardId = savedCardSelect.value;

          document.getElementById('saved_card_id').value = selectedCardId;

        
          const cardNumberLabel = document.getElementById('cardNumberLabel');
          const cvvLabel = document.getElementById('cvvLabel');
          const expiryDateLabel = document.getElementById('expiryDateLabel');
        
          if (selectedCardId) {
            // If a saved card is selected, hide card number, show expiry (readonly) and CVV
            cardNumberLabel.classList.add('hidden');
            expiryDateLabel.classList.remove('hidden');
            cvvLabel.classList.remove('hidden');

            const expiryInput = document.querySelector('input[name="expiry_date"]');
            if (expiryInput) {
              expiryInput.readOnly = false; 
              expiryInput.value = data.formatted_expiry; 
            }
        
            // Fetch saved card details from your backend
            fetch(`/payment-methods/${selectedCardId}/`)
              .then(response => response.json())
              .then(data => {
                document.querySelector('input[name="card_number"]').value = data.masked_number;
                document.querySelector('input[name="expiry_date"]').value = "";
                document.querySelector('input[name="expiry_date"]').focus();
                document.querySelector('input[name="cvv"]').value = "";
                document.querySelector('input[name="cvv"]').focus();
              })
              .catch(error => {
                console.error('Error loading saved card details:', error);
              });
          } else {
            // If no saved card selected, show the full card input fields
            togglePaymentFields();
          }
        } 

        function deleteSelectedCard() {
          const selectedCardId = document.getElementById('saved_cards').value;
          if (!selectedCardId) {
            alert("Please select a saved card to delete.");
            return;
          }
        
          if (!confirm("Are you sure you want to delete this saved card?")) return;
        
          const urlTemplate = document.getElementById('delete-card-url-template').dataset.url;
          const deleteUrl = urlTemplate.replace('/0/', `/${selectedCardId}/`);
        
          console.log("Deleting card at:", deleteUrl); // ✅ Debug 输出路径
        
          fetch(deleteUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              alert("Card deleted successfully.");
              document.getElementById('saved_cards').value = '';
              document.getElementById('saved_card_id').value = '';
              loadSavedPaymentMethods();  // 重新加载卡列表
            } else {
              alert("Error: " + data.message);
            }
          })
          .catch(error => {
            console.error("Error deleting card:", error);
            alert("Something went wrong.");
          });
        }
        

      document.addEventListener('DOMContentLoaded', function() {
        const storedMerchantEmail = localStorage.getItem('merchant_email');
        const storedAmount = localStorage.getItem('amount');
        const storedCurrency = localStorage.getItem('currency');
        const storedPaymentMethod = localStorage.getItem('payment_method');
        const storedCardNumber = localStorage.getItem('card_number');
        const storedCvv = localStorage.getItem('cvv');
        if (storedMerchantEmail) document.querySelector('input[name="merchant_email"]').value = storedMerchantEmail;
        if (storedAmount) document.querySelector('input[name="amount"]').value = storedAmount;
        if (storedCurrency) document.querySelector('select[name="currency"]').value = storedCurrency;
        if (storedPaymentMethod) document.querySelector('select[name="payment_method"]').value = storedPaymentMethod;
        if (storedCardNumber) document.querySelector('input[name="card_number"]').value = storedCardNumber;
        if (storedCvv) document.querySelector('input[name="cvv"]').value = storedCvv;
        calculateTotalCost();
        togglePaymentFields();
        // Load saved payment methods
        loadSavedPaymentMethods();
        document.getElementById('saved_cards').addEventListener('change', handleSavedCardSelection);
        document.getElementById('paymentMethod').addEventListener('change', handleSavedCardSelection);
      });

      document.addEventListener('DOMContentLoaded', () => {
        const savedCardSelect     = document.getElementById('saved_cards');
        const paymentMethodSelect = document.getElementById('paymentMethod');
        const cardNumberLabel     = document.getElementById('cardNumberLabel');
        const expiryDateLabel     = document.getElementById('expiryDateLabel');
        const cvvLabel            = document.getElementById('cvvLabel');
        const walletSection       = document.getElementById('walletSection');
    
        function updateFormState() {
          const hasSaved  = savedCardSelect.value !== "";
          const hasMethod = paymentMethodSelect.value !== "";
    
          // Reset all controls' states
          savedCardSelect.disabled     = false;
          paymentMethodSelect.disabled = false;
          savedCardSelect.classList.remove('disabled-style');
          paymentMethodSelect.classList.remove('disabled-style');
          cardNumberLabel.classList.add('hidden');
          expiryDateLabel.classList.add('hidden');
          cvvLabel.classList.add('hidden');
          walletSection.classList.add('hidden');
    
          if (hasSaved) {
            // If Saved Card is selected → Disable payment method, show Expiry + CVV
            paymentMethodSelect.disabled = true;
            paymentMethodSelect.classList.add('disabled-style');
            expiryDateLabel.classList.remove('hidden');
            cvvLabel.classList.remove('hidden');
          }
          else if (hasMethod) {
            // If Payment Method is selected → Disable Saved Card
            savedCardSelect.disabled = true;
            savedCardSelect.classList.add('disabled-style');
    
            if (paymentMethodSelect.value === 'SAFEPAY WALLET') {
              // If it's a wallet → Show only wallet balance section
              walletSection.classList.remove('hidden');
            } else {
              // For other card types → Show Card Number, Expiry, CVV
              cardNumberLabel.classList.remove('hidden');
              expiryDateLabel.classList.remove('hidden');
              cvvLabel.classList.remove('hidden');
            }
          }
          // If neither is selected, keep everything enabled and hide detailed fields
        }
    
        savedCardSelect.addEventListener('change', updateFormState);
        paymentMethodSelect.addEventListener('change', updateFormState);
        updateFormState();  // Run once initially
      });
      
    </script>

    <span id="delete-card-url-template" data-url="{% url 'delete_saved_card' 0 %}"></span>
  
  </body>
</html>